<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .dir {
            color: #0066cc;
            font-weight: bold;
        }
        .file {
            color: #333;
        }
        .time {
            font-family: monospace;
        }
        /* LoadingÊµÆÂ±ÇÊ†∑Âºè */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.55); /* ÈÄèÊòéÂ∫¶45% */
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .loading-content {
            background-color: white;
            padding: 20px 40px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            max-width: 80%;
            max-height: 80%;
            overflow-y: auto;
        }
        .loading-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        .loading-file {
            margin: 5px 0;
            padding: 5px;
            border-radius: 4px;
        }
        .loading-file.uploading {
            background-color: #f0f8ff;
            color: #0066cc;
        }
        .loading-file.success {
            background-color: #f0fff0;
            color: #008000;
        }
        .loading-file.error {
            background-color: #fff0f0;
            color: #ff0000;
        }
    </style>
</head>
<body>
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1>{{ title }}</h1>
        <a href="/" style="text-decoration: none; color: #0066cc; font-size: 16px; padding: 5px 10px; border: 1px solid #0066cc; border-radius: 4px;">ËøîÂõûÈ¶ñÈ°µ</a>
    </div>
    <!-- È°∂ÈÉ®ÂØºËà™Ê†è -->
    <div style="display: flex; justify-content: space-between; align-items: center; ">
        <div>{{ path }}  <small><button onclick="goToParentDirectory()">‰∏ä‰∏ÄÁ∫ß</button></small></div>
        <!-- Êñá‰ª∂‰∏ä‰º†Âå∫Âüü -->
        <div>
            <input type="file" id="fileInput" style="display: none;" multiple onchange="uploadFiles()">
            <button onclick="document.getElementById('fileInput').click()">‰∏ä‰º†Êñá‰ª∂</button>
        </div>
    </div>

    <table>
        <tr>
            <th>ÂêçÁß∞</th>
            <th class="size">Â§ßÂ∞è</th>
            <th>‰øÆÊîπÊó∂Èó¥</th>
            <th>Êìç‰Ωú</th>
        </tr>
        {% for entry in entries %}
        <tr>
            <td>
                <span class="{{ entry.Type }}">
                    {% if entry.Type == "dir" %}üìÅ {% else %}üìÑ {% endif %}
                    <a href="/{{ url }}/{{ entry.Name }}">{{ entry.Name }}</a>
                </span>
               
            </td>
            <td class="size">{{ entry.Size }}</td>
            <td class="time">{{ entry.ModifyTime  }}</td>
            <td>
             <button onclick="deleteItem('{{ entry.Name }}', '{{ entry.Type }}')" style=" cursor: pointer;">Âà†Èô§</button>
            </th>
        </tr>
        {% endfor %}
    </table>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-title">Êñá‰ª∂‰∏ä‰º†‰∏≠</div>
            <div id="loadingFiles"></div>
        </div>
    </div>
    <script>
    function goToParentDirectory() {
        const path = window.location.pathname.replace(/\/+$/, '');
        const parentPath = path.substring(0, path.lastIndexOf('/')) || '/';
        window.location.href = window.location.origin + parentPath;
    }

    // Êñá‰ª∂Âà†Èô§ÂäüËÉΩ
    function deleteItem(name, type) {
        // Á°ÆËÆ§Âà†Èô§
        if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§${type === 'dir' ? 'ÁõÆÂΩï' : 'Êñá‰ª∂'} "${name}"ÂêóÔºü`)) {
            return;
        }

        // Ëé∑ÂèñÂΩìÂâçË∑ØÂæÑ‰ø°ÊÅØ
        const path = window.location.pathname.replace(/\/+$/, '');
        
        // ÊûÑÈÄ†Âà†Èô§URLÔºöÂΩìÂâçURL + Êñá‰ª∂Âêç
        const deleteUrl = `${path}/${name}`;
        
        fetch(deleteUrl, {
            method: 'DELETE'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Âà†Èô§Â§±Ë¥•: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.code === 0) {
                alert('Âà†Èô§ÊàêÂäü');
                // Âà∑Êñ∞È°µÈù¢
                window.location.reload();
            } else {
                throw new Error(`Âà†Èô§Â§±Ë¥•: ${data.message || 'Êú™Áü•ÈîôËØØ'}`);
            }
        })
        .catch(error => {
            alert(`Âà†Èô§Â§±Ë¥•: ${error.message}`);
        });
    }
    

    

    // Êñá‰ª∂‰∏ä‰º†ÂäüËÉΩ
    function uploadFiles() {
        const fileInput = document.getElementById('fileInput');
        const files = fileInput.files;
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingFiles = document.getElementById('loadingFiles');
        const path = window.location.pathname.replace(/\/+$/, '');

        if (files.length === 0) {
            alert('ËØ∑ÂÖàÈÄâÊã©Êñá‰ª∂');
            return;
        }

        // ÊòæÁ§∫LoadingÊµÆÂ±Ç
        loadingOverlay.style.display = 'flex';
        loadingFiles.innerHTML = '';

        // ÂàùÂßãÂåñÊâÄÊúâÊñá‰ª∂ÁöÑ‰∏ä‰º†Áä∂ÊÄÅ
        Array.from(files).forEach(file => {
            const fileElement = document.createElement('div');
            fileElement.className = 'loading-file uploading';
            fileElement.id = `loading_${file.name.replace(/[^a-zA-Z0-9]/g, '_')}`;
            fileElement.innerHTML = `‚åõ Á≠âÂæÖ‰∏ä‰º†‰∏≠: ${file.name}`;
            loadingFiles.appendChild(fileElement);
        });

        // ËÆ∞ÂΩïÂ∑≤ÂÆåÊàêÁöÑÊñá‰ª∂Êï∞Èáè
        let completedFiles = 0;
        let total = files.length

        // ÈÄê‰∏™‰∏ä‰º†Êñá‰ª∂
        Array.from(files).forEach((file) => {
            const formData = new FormData();
            formData.append('file', file);

            // ÊûÑÈÄ†‰∏ä‰º†URLÔºöÂΩìÂâçURL + Êñá‰ª∂Âêç
            const uploadUrl = `${path}/${file.name}`;
            // Êõ¥Êñ∞Êñá‰ª∂Áä∂ÊÄÅ‰∏∫ÊàêÂäü
            const fileId = `loading_${file.name.replace(/[^a-zA-Z0-9]/g, '_')}`;
            const fileElement = document.getElementById(fileId);
            fileElement.innerHTML = `Ê≠£Âú®‰∏ä‰º†: ${file.name}`;
            fetch(uploadUrl, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`‰∏ä‰º†Â§±Ë¥•: ${response.statusText}`);
                }
                return response.text();
            })
            .then(data => {
                // Êõ¥Êñ∞Êñá‰ª∂Áä∂ÊÄÅ‰∏∫ÊàêÂäü
                const fileId = `loading_${file.name.replace(/[^a-zA-Z0-9]/g, '_')}`;
                const fileElement = document.getElementById(fileId);
                if (fileElement) {
                    fileElement.className = 'loading-file success';
                    fileElement.innerHTML = `‚úÖ ‰∏ä‰º†ÊàêÂäü: ${file.name}`;
                }
            }).catch(error => {
                // Êõ¥Êñ∞Êñá‰ª∂Áä∂ÊÄÅ‰∏∫Â§±Ë¥•
                const fileId = `loading_${file.name.replace(/[^a-zA-Z0-9]/g, '_')}`;
                const fileElement = document.getElementById(fileId);
                if (fileElement) {
                    fileElement.className = 'loading-file error';
                    fileElement.innerHTML = `‚ùå ‰∏ä‰º†Â§±Ë¥•: ${file.name} (${error.message})`;
                }
            })
            .finally(() => {
                completedFiles++;
                console.log(completedFiles, files.length)
                // Ê£ÄÊü•ÊòØÂê¶ÊâÄÊúâÊñá‰ª∂ÈÉΩÂ∑≤‰∏ä‰º†ÂÆåÊàê
                if (completedFiles === total) {
                    // ÊâÄÊúâÊñá‰ª∂‰∏ä‰º†ÂÆåÊàêÔºå1ÁßíÂêéÂà∑Êñ∞È°µÈù¢
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                }
            });
        });

        // Ê∏ÖÁ©∫Êñá‰ª∂ÈÄâÊã©
        fileInput.value = '';
    }
    </script>
</body>
</html>